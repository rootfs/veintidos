#!/bin/bash

set -e

declare -a snaps

snaps=(
    2016-04-15T18:03:06Z
    2016-04-16T18:01:15Z
    2016-04-17T18:01:01Z
    2016-04-18T18:02:13Z
    2016-04-19T18:12:47Z
    2016-04-21T18:04:52Z
    2016-04-22T18:02:54Z
    2016-04-23T18:01:08Z
    2016-04-24T18:01:10Z
    2016-04-25T18:05:08Z
    2016-04-26T18:01:40Z
    2016-04-27T18:05:04Z
    2016-04-28T18:04:54Z
    2016-04-29T18:05:10Z
    2016-04-30T18:01:22Z
    2016-05-01T18:01:21Z
    2016-05-03T18:05:36Z
    2016-05-04T18:02:11Z
    2016-05-05T18:01:25Z
    2016-05-06T18:01:25Z
    2016-05-07T18:01:24Z
    2016-05-08T18:01:26Z
    2016-05-10T18:04:12Z
    2016-05-11T18:05:50Z
    2016-05-12T18:05:12Z
    2016-05-13T18:04:14Z
    2016-05-14T18:01:34Z
    2016-05-15T18:01:33Z
    2016-05-16T18:01:35Z
    2016-05-17T18:03:23Z
    2016-05-18T18:04:30Z
    2016-05-21T18:04:55Z
    2016-05-22T18:05:55Z
    2016-05-23T18:04:08Z
    2016-05-24T18:04:35Z
    2016-05-25T18:04:15Z
    2016-05-26T18:03:49Z
    2016-05-27T18:02:07Z
    2016-05-28T18:02:05Z
    2016-05-29T18:03:00Z
    2016-06-01T18:05:39Z
    2016-06-02T18:03:40Z
    2016-06-03T18:07:31Z
    2016-06-08T18:05:12Z
    2016-06-11T18:03:38Z
    2016-06-12T18:03:29Z
    2016-06-13T18:04:36Z
    2016-06-14T18:09:14Z
    2016-06-16T18:04:26Z
    2016-06-17T18:04:56Z
    2016-06-18T18:04:13Z
    2016-06-20T18:08:17Z
    2016-06-21T18:09:09Z
    2016-06-22T18:07:54Z
    2016-06-23T18:07:46Z
    2016-06-24T18:07:53Z
    2016-06-25T18:07:31Z
    2016-06-26T18:07:53Z
    2016-06-27T18:07:20Z
    2016-06-28T18:07:48Z
    2016-06-29T18:08:09Z
    2016-06-30T18:07:54Z
    2016-07-05T18:05:35Z
    2016-07-06T18:05:36Z
    2016-07-07T18:08:06Z
    2016-07-09T18:03:13Z
    2016-07-10T18:01:55Z)

snap_dir="/epsilon/backups/neuromancer/.zfs/snapshot/"

snap_tar ()
{
    sudo tar cvf - \
	 --exclude="./tmp/*" \
	 --exclude="./var/lib/docker/*" \
	 --exclude="./var/lib/sss/pipes/*" \
	 --exclude="./var/cache/apt/archives/*" \
	 --one-file-system \
	 -C \
	 /epsilon/backups/neuromancer/.zfs/snapshot/$1 \
	 / \
	 2> >(ts > "log/tar_$1.log")
}

for snap in ${snaps[@]}; do
    echo "------------> Writing $snap"

    set -x

    time ./veintidos.py --debug --compression put "neuromancer@${snap}" \
	 <(snap_tar "$snap") \
	 2>&1 | ts | tee "log/veintidos_${snap}.log" | egrep '(PUT|GET|UP|DOWN|version)'
    time ./veintidos.py ls > "log/after_snap_${snap}.ls"
    ceph osd df > "log/after_snap_${snap}.df"

    set +x
done
